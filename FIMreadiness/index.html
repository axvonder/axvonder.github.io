<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FIM Organizational Readiness Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#667085;
      --primary:#0B6BCB;
      --primary-strong:#084f98;
      --surface:#f7f9fc;
      --ok:#166534;
      --warn:#b45309;
      --bad:#b91c1c;
      --focus:#93c5fd;
      --border:#d1d5db;
      --pill-bg:#ffffff;
      --pill-bg-selected:#0B6BCB;
      --pill-text:#111827;
      --pill-text-selected:#ffffff;
      --pill-border:#cbd5e1;
      --pill-border-selected:#0B6BCB;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.45;
    }

    /* Header */
    header{
      border-bottom:1px solid var(--border);
      background:#fff;
      position:sticky;
      top:0;
      z-index:10;
    }
    header .wrap{
      max-width:1000px;
      margin:0 auto;
      padding:16px 20px;
      display:flex; flex-direction:column; gap:6px;
    }
    header h1{font-size:1.25rem; margin:0}
    header p{margin:0; color:var(--muted); font-size:.95rem}
    .hide-subtitle header p{display:none}

    main{max-width:1000px; margin:0 auto; padding:20px}
    .card{
      background:#fff; border:1px solid var(--border); border-radius:10px; padding:18px;
      box-shadow:0 1px 2px rgba(0,0,0,.03);
      overflow:hidden;
    }
    input[type="text"]{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:1rem;
    }
    .actions{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--primary); background:var(--primary); color:#fff;
      border-radius:8px; padding:9px 14px; font-size:1rem; cursor:pointer; line-height:1.2;
    }
    .btn.secondary{background:#fff; color:var(--primary)}
    .btn.ghost{background:#fff; color:#111827; border-color:var(--border)}
    .btn.small{padding:6px 10px; font-size:.9rem}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn:focus-visible{outline:3px solid var(--focus); outline-offset:2px}

    /* Start */
    .start{display:none}
    .start.active{display:block; max-width:720px; margin:0 auto}

    /* Domain */
    .domain{display:none}
    .domain.active{display:block}
    .progress{display:flex; align-items:center; gap:12px; margin-bottom:12px; color:var(--muted); font-size:.95rem}
    .progressbar{flex:1; height:8px; background:var(--surface); border-radius:999px; overflow:hidden; border:1px solid var(--border)}
    .progressbar .fill{height:100%; width:0; background:var(--primary); transition:width .2s ease}
    #domainCard h2{margin:0 0 10px 0}
    fieldset{border:0; padding:0; margin:0}
    legend{font-weight:600; padding:0; margin:0 0 8px 0}

    .item{padding:12px 0}
    .item + .item{margin-top:6px}

    .scale{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(132px, 1fr));
      gap:8px; margin-top:8px;
    }
    /* Pill radio */
    .option{
      position:relative;
      display:flex; align-items:center; justify-content:center;
      padding:7px 12px;
      border:1.5px solid var(--pill-border);
      border-radius:999px;
      background:var(--pill-bg);
      color:var(--pill-text);
      font-size:.94rem;
      min-height:36px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      white-space:normal;
      transition:background .12s ease, color .12s ease, border-color .12s ease;
    }
    .option input{
      position:absolute; opacity:0; inset:0; width:100%; height:100%; margin:0; cursor:pointer;
    }
    .option.selected{
      background:var(--pill-bg-selected);
      color:var(--pill-text-selected);
      border-color:var(--pill-border-selected);
      box-shadow:0 0 0 2px rgba(11,107,203,.16) inset;
      font-weight:500; /* steady to limit reflow */
    }
    .option span{display:block; line-height:1.2}
    .option:focus-within{outline:3px solid var(--focus); outline-offset:2px}

    /* Domain F helper bar */
    .fbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0 10px 0}
    .muted{color:var(--muted)}
    .disabled .option{pointer-events:none; opacity:.55}

    /* Sticky controls */
    .sticky-controls{
      position:sticky; bottom:0; left:0; right:0; background:#fff; border-top:1px solid var(--border);
      padding:10px 20px; z-index:5;
    }
    .sticky-controls .wrap{
      max-width:1000px; margin:0 auto; display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
    }
    .saved-toast{font-size:.9rem; color:var(--muted)}

    /* Results */
    .results{display:none}
    .results.active{display:block}
    .hero{display:flex; align-items:flex-end; gap:14px; flex-wrap:wrap; margin:8px 0 6px 0}
    .score-badge{font-weight:700; font-size:2rem; padding:8px 12px; border-radius:8px; background:var(--surface); border:1px solid var(--border)}
    .tier{font-weight:700; padding:6px 10px; border-radius:999px; font-size:.95rem}
    .tier.low{background:#fee2e2; color:var(--bad); border:1px solid #fecaca}
    .tier.mod{background:#fff7ed; color:var(--warn); border:1px solid #ffedd5}
    .tier.high{background:#dcfce7; color:var(--ok); border:1px solid #bbf7d0}
    .chart-wrap{background:#fff; border:1px solid var(--border); border-radius:10px; padding:14px}
    .grid{display:grid; gap:14px}
    .grid-2{grid-template-columns:1fr 1fr}
    @media (max-width:840px){.grid-2{grid-template-columns:1fr}}

    .gap-list li{margin-bottom:10px}
    .gap-list .pct{display:block; margin-top:2px; margin-bottom:2px}
    .gap-list .tip{display:block; margin-top:2px}

    .visually-hidden{position:absolute !important;clip:rect(1px,1px,1px,1px);clip-path:inset(50%);height:1px;width:1px;overflow:hidden;white-space:nowrap;border:0;padding:0;margin:-1px}

    :focus{outline:none}
    :focus-visible{outline:3px solid var(--focus); outline-offset:2px}

    /* Print */
    @media print{
      header,.domain,.start,.sticky-controls{display:none !important}
      main{padding:0; max-width:none}
      .results{display:block !important}
      .results .actions{display:none}
      .chart-wrap{page-break-inside:avoid}
      body{background:#fff}
    }
  </style>
</head>
<body>
  <a href="#app-main" class="visually-hidden">Skip to content</a>

  <header role="banner" aria-label="Header">
    <div class="wrap">
      <h1 id="app-title">FIM Organizational Readiness Assessment</h1>
      <p id="subtitle">Rate each domain, then review your score, tier, and a recommended starting model.</p>
    </div>
  </header>

  <main id="app-main" tabindex="-1">
    <!-- Start -->
    <section id="start" class="start card active" aria-labelledby="start-h">
      <h2 id="start-h" style="margin-top:0">Get started</h2>
      <div>
        <label for="orgName">Organization name</label>
        <input id="orgName" name="orgName" type="text" autocomplete="organization" />
      </div>
      <div class="actions" style="margin-top:12px">
        <button id="beginBtn" class="btn" type="button">Begin</button>
        <button id="clearBtn" class="btn ghost" type="button" aria-describedby="clearHelp">Reset</button>
        <span id="clearHelp" class="muted" style="font-size:.9rem">Clears saved entries from this browser.</span>
      </div>
    </section>

    <!-- Domain screen -->
    <section id="domain" class="domain" aria-live="polite">
      <div class="progress" aria-label="Progress">
        <div id="progressText">Domain 1 of 9</div>
        <div class="progressbar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="fill" id="progressFill" style="width:0%"></div>
        </div>
      </div>
      <div id="domainCard" class="card" tabindex="-1"><!-- injected --></div>
    </section>

    <!-- Sticky controls -->
    <div id="controls" class="sticky-controls" role="region" aria-label="Navigation controls" hidden>
      <div class="wrap">
        <div class="left">
          <button id="backBtn" class="btn secondary" type="button">Back</button>
          <button id="nextBtn" class="btn" type="button">Next</button>
        </div>
        <div class="right">
          <button id="saveBtn" class="btn ghost" type="button" aria-describedby="saveHelp">Save for later</button>
          <div id="saveHelp" class="visually-hidden">Saves your entries to this browser using local storage.</div>
          <div class="saved-toast" id="saveToast" role="status" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <!-- Results -->
    <section id="results" class="results" aria-labelledby="results-h">
      <div class="card">
        <h2 id="results-h" style="margin-top:0">Results</h2>

        <div class="hero">
          <div class="score-badge" id="overallScore" aria-live="polite">0%</div>
          <div id="tierBadge" class="tier low" aria-live="polite">Tier: Low</div>
        </div>

        <div class="muted" id="orgLine"></div>

        <div class="chart-wrap" aria-label="Domain scores chart">
          <canvas id="barChart" aria-label="Horizontal bar chart of domain scores" role="img"></canvas>
          <div id="chartFallback" class="muted" style="display:none">Chart unavailable. Scores listed below.</div>
        </div>

        <div id="excludedNote" class="muted" style="margin-top:8px;display:none"></div>

        <div class="grid grid-2" style="margin-top:16px">
          <div>
            <h3 style="margin-top:0">Top gaps</h3>
            <ol id="gapList" class="gap-list"></ol>
          </div>
          <div>
            <h3 style="margin-top:0">Recommended starting model</h3>
            <p id="recommendText" class="recommend"></p>
            <div id="recommendWhy" class="muted"></div>
          </div>
        </div>

        <div class="actions" style="margin-top:14px">
          <button id="printBtn" class="btn secondary" type="button">Print or Save PDF</button>
          <button id="csvBtn" class="btn secondary" type="button">Download CSV</button>
          <button id="restartBtn" class="btn" type="button">Start over</button>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /* ---------- Config (your Section 3 language) ---------- */
    const CONFIG = {
      "meta": {
        "title": "FIM Organizational Readiness Assessment",
        "version": "v1.0",
        "criticalDomains": ["A","C","G","H"],
        "weights": { "A":1.5, "B":1.0, "C":1.5, "D":1.0, "E":1.0, "F":1.0, "G":1.5, "H":1.5, "I":1.0 }
      },
      "domains": {
        "A": { "name": "Strategic Alignment", "items": [
          "Our organization recognizes food and/or nutrition security as a health-related social need.",
          "Nutrition-based intervention is part of our organization’s strategic plan or population health goals.",
          "Our organization has existing programs addressing diet-related chronic conditions."
        ]},
        "B": { "name": "Leadership & Administrative Support", "items": [
          "There is executive-level support for integrating FIM into clinical workflows.",
          "There are identified FIM champions within leadership and clinical teams.",
          "There is a governance structure to oversee FIM implementation."
        ]},
        "C": { "name": "Clinical Integration Capacity", "items": [
          "Food insecurity screening tools (e.g., Hunger Vital Sign) are used routinely.",
          "Screening is integrated into the EHR and clinical workflows.",
          "There are existing protocols for referral to nutrition services or community food resources."
        ]},
        "D": { "name": "Staffing & Training", "items": [
          "Staff have been trained in nutrition-sensitive care and FIM principles.",
          "There is capacity (time, roles) for staff to support FIM activities.",
          "There are community health workers or care coordinators involved in patient care or navigation."
        ]},
        "E": { "name": "Community Partnerships", "items": [
          "There are existing partnerships with food banks, farms, pantries, or FIM vendors.",
          "There are existing MOUs, contracts, or agreements in place with FIM vendors.",
          "There is a mechanism for closed-loop FIM referrals and follow-up."
        ]},
        "F": { "name": "Infrastructure & Logistics", "items": [
          "There is a physical space for food distribution (e.g., office, pantry, fridge, freezer, etc.).",
          "There are systems in place for storing and handling food safely.",
          "There is a plan for sourcing culturally appropriate and medically tailored foods."
        ], "conditional": true },
        "G": { "name": "Funding & Program Sustainability", "items": [
          "There is dedicated funding for FIM activities (e.g., grants, Medicaid waivers, philanthropic funding).",
          "There are billing pathways or reimbursement models in place.",
          "There is a plan in place to sustain FIM programming beyond initial funding."
        ]},
        "H": { "name": "Data & Evaluation", "items": [
          "There are systems for tracking FIM outcomes (clinical, utilization, satisfaction).",
          "There is capacity for data sharing with FIM vendors and/or community partners.",
          "There are evaluation metrics aligned with an existing analytic framework (e.g., HHS Food is Medicine Analytic Framework, AHA Healthcare by Food Common Measures)."
        ]},
        "I": { "name": "Equity & Access", "items": [
          "Under-resourced populations are prioritized in our organization’s FIM program design.",
          "There are strategies in place to ensure uninsured or underinsured patients can receive FIM programs.",
          "There is patient and community input in FIM programming and evaluation."
        ]}
      }
    };

    const TIPS = {
      "A": "Add a funded FIM objective with sponsor and KPI to the FY plan.",
      "B": "Stand up governance with named clinical and ops leads and a quarterly cadence.",
      "C": "Embed screening in EHR, publish the order set, and finalize protocols.",
      "D": "Allocate capacity for coordination and complete staff training.",
      "E": "Execute an MOU and enable closed-loop referral updates.",
      "F": "Stand up cold chain, SOPs, and a culturally appropriate sourcing plan.",
      "G": "Secure 12-month runway, validate billing, and document the multi-year plan.",
      "H": "Launch an outcomes dashboard, execute DUAs, and automate weekly data feeds.",
      "I": "Ensure access strategies for uninsured patients and add patient/community voice."
    };

    /* ---------- State ---------- */
    const STORAGE_KEY = "fim_readiness_v1";
    const state = { orgName:"", responses:{}, currentIndex:0, fNoInHouse:false };
    for (const code of Object.keys(CONFIG.domains)) {
      const len = CONFIG.domains[code].items.length;
      state.responses[code] = Array.from({length: len}, () => null);
    }

    /* ---------- Helpers ---------- */
    const $  = s => document.querySelector(s);
    function saveLocal(msg=true){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); if(msg) toast("Saved"); }catch(e){ toast("Could not save"); } }
    function loadLocal(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; const saved=JSON.parse(raw)||{}; state.orgName=saved.orgName||""; state.responses=saved.responses||state.responses; state.currentIndex=Number.isInteger(saved.currentIndex)?saved.currentIndex:0; state.fNoInHouse=!!saved.fNoInHouse; }catch(e){} }
    function clearLocal(){ localStorage.removeItem(STORAGE_KEY); }
    function toast(t){ const el=$("#saveToast"); el.textContent=t; setTimeout(()=>el.textContent="", 1500); }
    function includedDomains(){ return Object.keys(CONFIG.domains); }

    /* ---------- Screens ---------- */
    const screens={start:$("#start"), domain:$("#domain"), results:$("#results"), controls:$("#controls")};
    function showScreen(name){
      ["start","domain","results"].forEach(k=>screens[k].classList.toggle("active", k===name));
      screens.controls.hidden = name!=="domain";
      document.body.classList.toggle("hide-subtitle", name!=="start");
      if (name==="start") $("#start-h").focus();
      if (name==="domain") $("#domainTitle")?.focus();
      if (name==="results") $("#results-h").focus();
    }

    function begin(){
      state.orgName = $("#orgName").value.trim();
      state.currentIndex = 0;
      saveLocal(false);
      renderDomain();
      updateProgress();
      showScreen("domain");
    }

    function wireScaleSelection(scale){
      const labels = Array.from(scale.querySelectorAll("label.option"));
      const inputs = Array.from(scale.querySelectorAll('input[type="radio"]'));
      function refresh(){ labels.forEach(l => l.classList.toggle("selected", l.querySelector("input").checked)); }
      inputs.forEach(inp=> inp.addEventListener("change", refresh));
      refresh();
    }

    function renderDomain(){
      const codes = includedDomains();
      const idx = Math.min(state.currentIndex, codes.length-1);
      state.currentIndex = idx;
      const code = codes[idx];
      const domain = CONFIG.domains[code];

      if (code==="F" && state.fNoInHouse) {
        state.responses["F"] = state.responses["F"].map(()=> "na");
      }

      const card = $("#domainCard");
      card.innerHTML = "";

      const h = document.createElement("h2");
      h.id = "domainTitle";
      h.textContent = `Domain ${code}: ${domain.name}`;
      h.tabIndex = -1;
      card.appendChild(h);

      if (code === "F"){
        const bar = document.createElement("div");
        bar.className = "fbar";
        const btn = document.createElement("button");
        btn.type="button";
        btn.id="fToggleBtn";
        btn.className="btn secondary small";
        btn.setAttribute("aria-pressed", state.fNoInHouse ? "true" : "false");
        btn.textContent = state.fNoInHouse ? "Undo" : "No in-house food distribution";
        const help = document.createElement("span");
        help.className="muted";
        help.textContent = "Sets all items to N/A and excludes this domain.";
        bar.appendChild(btn);
        bar.appendChild(help);
        card.appendChild(bar);

        btn.addEventListener("click", ()=>{
          state.fNoInHouse = !state.fNoInHouse;
          if (state.fNoInHouse){
            state.responses["F"] = state.responses["F"].map(()=> "na");
          } else {
            state.responses["F"] = state.responses["F"].map(()=> null);
          }
          saveLocal(false);
          renderDomain();
        });
      }

      const fs = document.createElement("fieldset");
      if (code==="F" && state.fNoInHouse) fs.classList.add("disabled");
      const values = state.responses[code] || [];

      domain.items.forEach((text, i) => {
        const itemFs = document.createElement("fieldset");
        itemFs.className = "item";
        const leg = document.createElement("legend");
        leg.textContent = text;
        itemFs.appendChild(leg);

        const scale = document.createElement("div");
        scale.className = "scale";
        scale.setAttribute("role","radiogroup");
        scale.setAttribute("aria-label","Agreement scale");

        /* Force two-line labels for the four longer options via <br> */
        const options = [
          {v:0, label:"Strongly disagree", labelHtml:"Strongly<br>disagree", aria:"0 Strongly disagree"},
          {v:1, label:"Somewhat disagree", labelHtml:"Somewhat<br>disagree", aria:"1 Somewhat disagree"},
          {v:2, label:"Neither", aria:"2 Neither"},
          {v:3, label:"Somewhat agree", labelHtml:"Somewhat<br>agree", aria:"3 Somewhat agree"},
          {v:4, label:"Strongly agree", labelHtml:"Strongly<br>agree", aria:"4 Strongly agree"},
          {v:"na", label:"N/A", aria:"Not applicable"}
        ];

        options.forEach(opt=>{
          const wrap = document.createElement("label");
          wrap.className = "option";
          const input = document.createElement("input");
          input.type = "radio";
          input.name = `item-${code}-${i}`;
          input.value = String(opt.v);
          input.setAttribute("aria-label", opt.aria || opt.label);
          if (values[i] === opt.v) input.checked = true;
          input.addEventListener("change", ()=>{
            state.responses[code][i] = (input.value === "na") ? "na" : Number(input.value);
            saveLocal(false);
          });
          const span = document.createElement("span");
          if (opt.labelHtml){ span.innerHTML = opt.labelHtml; } else { span.textContent = opt.label; }
          wrap.appendChild(input);
          wrap.appendChild(span);
          scale.appendChild(wrap);
        });

        itemFs.appendChild(scale);
        fs.appendChild(itemFs);
        wireScaleSelection(scale);
      });

      card.appendChild(fs);

      const isLast = state.currentIndex === (codes.length-1);
      $("#nextBtn").textContent = isLast ? "See results" : "Next";
    }

    function updateProgress(){
      const codes = includedDomains();
      const total = codes.length;
      const idx = state.currentIndex + 1;
      $("#progressText").textContent = `Domain ${idx} of ${total}`;
      const pct = Math.round((idx-1) / total * 100);
      $("#progressFill").style.width = `${pct}%`;
      document.querySelector(".progressbar").setAttribute("aria-valuenow", String(pct));
    }

    function goNext(){
      const codes = includedDomains();
      const last = codes.length - 1;
      if (state.currentIndex >= last){ computeAndShowResults(); }
      else { state.currentIndex++; saveLocal(false); renderDomain(); updateProgress(); }
    }
    function goBack(){ if (state.currentIndex===0){ showScreen("start"); } else { state.currentIndex--; saveLocal(false); renderDomain(); updateProgress(); } }

    /* ---------- Scoring ---------- */
    function computeScores(){
      const codes = includedDomains();
      const weights = CONFIG.meta.weights;
      const critical = CONFIG.meta.criticalDomains;

      const domainMeans={}, domainPercents={}, allNA={};
      for (const code of codes){
        const items = state.responses[code] || [];
        const nums = items.filter(v => typeof v === "number");
        if (nums.length === 0){ domainMeans[code]=null; domainPercents[code]=null; allNA[code]=true; }
        else{
          const mean = nums.reduce((a,b)=>a+b,0)/nums.length;
          domainMeans[code]=mean; domainPercents[code]=mean/4*100; allNA[code]=false;
        }
      }

      let num=0, den=0;
      for (const code of codes){
        const p = domainPercents[code];
        if (p!==null){ const w=weights[code]??1.0; num += w*p; den += w; }
      }
      const overallPercent = den>0 ? (num/den) : null;

      let gatingHit=false;
      for (const cd of critical){
        if (!codes.includes(cd)) continue;
        const p = domainPercents[cd];
        if (p!==null && p<50){ gatingHit=true; break; }
      }

      return {codes, domainMeans, domainPercents, allNA, overallPercent, gatingHit};
    }

    function decideTier(overall, gatingHit){
      if (overall===null) return {tier:"Low", className:"low"};
      let t="Low", c="low";
      if (overall < 40) { t="Low"; c="low"; }
      else if (overall <= 70) { t="Moderate"; c="mod"; }
      else { t="High"; c="high"; }
      if (t==="High" && gatingHit) { t="Moderate"; c="mod"; }
      return {tier:t, className:c};
    }

    function decideModel(domainPercents){
      const get = c => domainPercents[c];
      const inHouseApplicable = get("F") !== null;
      const Aok = (get("A") ?? -1) >= 70;
      const Cok = (get("C") ?? -1) >= 70;
      const Gok = (get("G") ?? -1) >= 70;
      const Hok = (get("H") ?? -1) >= 70;
      const Fok = inHouseApplicable ? ((get("F") ?? -1) >= 70) : true;

      if (Aok && Cok && Gok && Hok && Fok){
        return {label:"In-house pilot", why:"Run distribution internally. Core domains are strong enough to start in-house."};
      }
      const reasons=[];
      if (get("C") !== null && get("C") < 50) reasons.push("clinical integration");
      if (get("H") !== null && get("H") < 50) reasons.push("data and evaluation");
      if (reasons.length){
        return {label:"Vendor-first", why:`Begin with a contracted food provision partner while you build ${reasons.join(" and ")} capacity.`};
      }
      return {label:"Hybrid", why:"Outsource food provision; keep screening, referral, and coaching in-house while you build capacity."};
    }

    /* ---------- Results ---------- */
    let chart;
    function computeAndShowResults(){
      const {codes, domainPercents, allNA, overallPercent, gatingHit} = computeScores();

      $("#overallScore").textContent = overallPercent===null ? "N/A" : `${(Math.round(overallPercent*10)/10).toFixed(1)}%`;
      const {tier, className} = decideTier(overallPercent, gatingHit);
      const badge = $("#tierBadge"); badge.className = `tier ${className}`;
      badge.textContent = `Tier: ${tier}`;

      const orgTitle = CONFIG.meta.title;
      const org = state.orgName ? `${state.orgName} • ${orgTitle}` : orgTitle;
      $("#orgLine").textContent = org;

      const labels=[], data=[], excluded=[];
      for (const code of codes){
        if (domainPercents[code] !== null){
          labels.push(`Domain ${code}: ${CONFIG.domains[code].name}`);
          data.push(Number((Math.round(domainPercents[code]*10)/10).toFixed(1)));
        } else if (allNA[code]) {
          excluded.push(`Domain ${code}: ${CONFIG.domains[code].name}`);
        }
      }
      try {
        if (chart){ chart.destroy(); }
        if (typeof Chart === "undefined") throw new Error("ChartJS not loaded");
        const canvas = document.getElementById("barChart");
        const chartHeight = Math.max(220, labels.length * 36 + 60);
        canvas.style.height = chartHeight + "px";
        chart = new Chart(canvas, {
          type:'bar',
          data:{ labels, datasets:[{label:'Percent', data, borderWidth:1, backgroundColor:'rgba(11,107,203,0.85)', borderColor:'#084f98'}] },
          options:{
            indexAxis:'y',
            responsive:true,
            maintainAspectRatio:false,
            scales:{ x:{ min:0, max:100, ticks:{ callback:v=>v+'%' } } },
            plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:ctx=>` ${ctx.raw}%` } } }
          }
        });
        $("#chartFallback").style.display = "none";
      } catch(e){
        $("#chartFallback").style.display = "block";
      }

      const exNote = $("#excludedNote");
      if (excluded.length){
        exNote.style.display = "block";
        exNote.textContent = `Excluded (all N/A): ${excluded.join("; ")}`;
      } else {
        exNote.style.display = "none";
        exNote.textContent = "";
      }

      const scorable = codes.filter(c => domainPercents[c] !== null).sort((a,b)=> domainPercents[a]-domainPercents[b]);
      const gapList = $("#gapList"); gapList.innerHTML = "";
      if (!scorable.length){
        const li=document.createElement("li"); li.textContent="No scored domains yet. Complete at least one domain to see gaps."; gapList.appendChild(li);
      } else {
        scorable.slice(0,3).forEach(code=>{
          const li=document.createElement("li");
          const pct = `${(Math.round(domainPercents[code]*10)/10).toFixed(1)}%`;
          li.innerHTML = `
            <strong>Domain ${code}: ${CONFIG.domains[code].name}</strong>
            <span class="pct muted">${pct}</span>
            <span class="tip muted">${TIPS[code]}</span>`;
          gapList.appendChild(li);
        });
      }

      const rec = decideModel(domainPercents);
      $("#recommendText").textContent = rec.label;
      $("#recommendWhy").textContent = rec.why;

      showScreen("results");
    }

    /* ---------- CSV ---------- */
    function downloadCSV(){
      const {domainMeans, domainPercents, allNA, overallPercent, gatingHit} = computeScores();

      const allCodes = Object.keys(CONFIG.domains);
      const head = ["org_name","date_time","in_house_food","version"];
      const itemCols=[], meanCols=[], pctCols=[], weightCols=[], includeCols=[];
      for (const code of allCodes){
        const n=CONFIG.domains[code].items.length;
        for (let i=0;i<n;i++) itemCols.push(`${code}${i+1}`);
        meanCols.push(`${code}_mean`); pctCols.push(`${code}_percent`); weightCols.push(`${code}_weight`); includeCols.push(`${code}_included`);
      }
      head.push(...itemCols, ...meanCols, ...pctCols, ...weightCols, ...includeCols, "overall_percent","tier","gating_applied","recommended_model");

      const row=[];
      function esc(v){ if(v===null||v===undefined) return ""; const s=String(v); return (s.includes(",")||s.includes("\"")||s.includes("\n"))?`"${s.replace(/"/g,'""')}"`:s; }

      row.push(state.orgName||"", new Date().toISOString(),
               (domainPercents["F"]!==null) ? "Derived: Yes" : "Derived: No",
               CONFIG.meta.version);

      for (const code of allCodes){
        const items=state.responses[code]||[]; const n=CONFIG.domains[code].items.length;
        for(let i=0;i<n;i++){ const v=items[i]; row.push(v===null?"":(v==="na"?"N/A":String(v))); }
      }
      for (const code of allCodes){ const m=domainMeans[code]; row.push(m==null||isNaN(m)?"":(Math.round(m*100)/100).toFixed(2)); }
      for (const code of allCodes){ const p=domainPercents[code]; row.push(p==null||isNaN(p)?"":(Math.round(p*10)/10).toFixed(1)); }
      for (const code of allCodes){ row.push(CONFIG.meta.weights[code]??1.0); }
      const inc=includedDomains();
      for (const code of allCodes){ const included=inc.includes(code)&&(domainPercents[code]!==null||allNA[code]===true); row.push(included?"Yes":"No"); }

      const {tier}=decideTier(overallPercent, gatingHit);
      const rec=decideModel(domainPercents);
      row.push(overallPercent==null?"":(Math.round(overallPercent*10)/10).toFixed(1), tier, gatingHit?"Yes":"No", rec.label);

      const csv=[head.join(","), row.map(esc).join(",")].join("\n");
      const blob=new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
      a.download=`fim_readiness_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click();
      URL.revokeObjectURL(a.href); a.remove();
    }

    /* ---------- Events / Init ---------- */
    function attachEvents(){
      $("#beginBtn").addEventListener("click", begin);
      $("#clearBtn").addEventListener("click", ()=>{
        if (confirm("Clear all saved entries?")){
          clearLocal(); $("#orgName").value="";
          state.orgName=""; for (const c of Object.keys(CONFIG.domains)){ const n=CONFIG.domains[c].items.length; state.responses[c]=Array.from({length:n},()=>null); }
          state.currentIndex=0; state.fNoInHouse=false; toast("Cleared");
        }
      });
      $("#backBtn").addEventListener("click", goBack);
      $("#nextBtn").addEventListener("click", goNext);
      $("#saveBtn").addEventListener("click", ()=> { saveLocal(true); });
      $("#printBtn").addEventListener("click", ()=> window.print());
      $("#csvBtn").addEventListener("click", downloadCSV);
      $("#restartBtn").addEventListener("click", ()=>{ if (confirm("Start over and clear all saved entries?")){ clearLocal(); window.location.reload(); }});
      $("#orgName").addEventListener("input", e=>{ state.orgName=e.target.value; saveLocal(false); });
    }
    function hydrateStart(){ $("#orgName").value = state.orgName || ""; }

    document.addEventListener("DOMContentLoaded", ()=>{ loadLocal(); attachEvents(); hydrateStart(); });
  </script>
</body>
</html>